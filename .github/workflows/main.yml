name: Build and Upload to Release

on:
  workflow_dispatch:
    inputs:
      pg_version:
        description: 'PostgreSQL 版本 (例如: 16.9)'
        required: true
        default: '16.9'
        type: string
      os_identifier:
        description: '操作系统标识 (例如: RockyLinux8, Ubuntu22.04)'
        required: true
        default: 'RockyLinux8'
        type: string
      pgbackrest_version:
        description: 'pgBackRest 版本 (例如: 2.54.2)'
        required: true
        default: '2.54.2'
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare build variables
        id: prep
        run: |
          PG_VERSION="${{ github.event.inputs.pg_version }}"
          OS_ID="${{ github.event.inputs.os_identifier }}"
          
          # 从 '16.9' 生成 '16'
          PG_MAJOR=$(echo $PG_VERSION | cut -d. -f1)
          
          # 构造 Dockerfile 的上下文路径 (新结构)
          # 结果示例: 16/rockylinux8
          CONTEXT_PATH="$PG_MAJOR/$OS_ID"
          echo "context_path=${CONTEXT_PATH}" >> $GITHUB_OUTPUT
          
          # 构造最终的归档文件名
          # 结果示例: postgresql-16.9-rockylinux8.tar.gz
          ARCHIVE_NAME="postgresql-${PG_VERSION}-${OS_ID}.tar.gz"
          echo "archive_name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
          
          # 构造 pg_rman 的分支名
          # 结果示例: REL_16_STABLE
          PGRMAN_BRANCH="REL_${PG_MAJOR}_STABLE"
          echo "pgrman_branch=${PGRMAN_BRANCH}" >> $GITHUB_OUTPUT

          echo "Context Path: ${CONTEXT_PATH}"
          echo "Archive Name: ${ARCHIVE_NAME}"
          echo "pg_rman Branch: ${PGRMAN_BRANCH}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and extract artifact
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.prep.outputs.context_path }}
          push: false
          build-args: |
            PG_VERSION=${{ github.event.inputs.pg_version }}
            PGBACKREST_VERSION=${{ github.event.inputs.pgbackrest_version }}
            PGRMAN_BRANCH=${{ steps.prep.outputs.pgrman_branch }}
            ARCHIVE_NAME=${{ steps.prep.outputs.archive_name }}
          outputs: type=local,dest=./output

      - name: Determine if Latest
        id: determine_latest
        uses: actions/github-script@v7
        with:
          script: |
            const newVersion = '${{ github.event.inputs.pg_version }}';
            let currentLatestVersion = '0.0';
            let makeLatest = 'true'; // 如果还没有任何 release，则默认为 true

            try {
              // 获取当前标记为 'latest' 的 release
              const { data: latestRelease } = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              currentLatestVersion = latestRelease.tag_name.replace(/^v/, ''); // 移除版本号可能带的 'v' 前缀
            } catch (error) {
              if (error.status === 404) {
                console.log('No latest release found. This build will be marked as latest.');
              } else {
                // 对于其他错误，则抛出异常
                throw error;
              }
            }
            
            // 比较版本号
            const newParts = newVersion.split('.').map(Number);
            const latestParts = currentLatestVersion.split('.').map(Number);
            const len = Math.max(newParts.length, latestParts.length);

            for (let i = 0; i < len; i++) {
              const newPart = newParts[i] || 0;
              const latestPart = latestParts[i] || 0;
              if (newPart > latestPart) {
                makeLatest = 'true';
                break;
              }
              if (newPart < latestPart) {
                makeLatest = 'false';
                break;
              }
            }

            console.log(`New version to build: ${newVersion}`);
            console.log(`Current latest version: ${currentLatestVersion}`);
            console.log(`Make this the latest release: ${makeLatest}`);
            
            core.setOutput('make_latest', makeLatest);

      - name: Upload Artifact to Release
        uses: ncipollo/release-action@v1
        with:
          artifactPath: ./output/${{ steps.prep.outputs.archive_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.event.inputs.pg_version }}
          allowUpdates: true
          generateReleaseNotes: true
          makeLatest: ${{ steps.determine_latest.outputs.make_latest }}